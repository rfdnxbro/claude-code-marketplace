name: テスト（scripts）

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
  pull_request:
    paths:
      - 'scripts/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v6

      - name: uvをセットアップ
        uses: astral-sh/setup-uv@v7

      - name: テストを実行（カバレッジ計測）
        working-directory: scripts
        run: |
          uvx --with pytest-cov pytest tests/ -v \
            --cov=validators \
            --cov-report=term \
            --cov-report=html:htmlcov \
            --cov-report=json:coverage.json \
            --cov-fail-under=100

      - name: カバレッジレポートをアーティファクトとして保存
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: scripts/htmlcov/

      - name: PRにカバレッジレポートをコメント
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERAGE_DATA_BRANCH: coverage-data
          COVERAGE_PATH: scripts/coverage.json

      - name: カバレッジ値を抽出
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: scripts
        run: |
          COVERAGE=$(python3 -c "import json; print(int(json.load(open('coverage.json'))['totals']['percent_covered']))")
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: カバレッジバッジを更新
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: coverage.json
          label: coverage
          message: ${{ env.COVERAGE }}%
          valColorRange: ${{ env.COVERAGE }}
          minColorRange: 50
          maxColorRange: 90
          namedLogo: pytest
