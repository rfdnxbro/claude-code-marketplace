name: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„ãƒã‚§ãƒƒã‚¯

on:
  push:
    branches: [main]
    paths:
      - '.claude/rules/**'
      - 'scripts/validators/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Issueä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆåˆ†æã®ã¿ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  id-token: write

concurrency:
  group: plugin-improvement-check
  cancel-in-progress: true

jobs:
  check-improvements:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: å¤‰æ›´ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«/ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’ç‰¹å®š
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹å‹•å®Ÿè¡Œ: å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡
            RULES=$(find .claude/rules -name '*.md' -type f | tr '\n' ',' | sed 's/,$//')
            VALIDATORS=$(find scripts/validators -name '*.py' -type f | tr '\n' ',' | sed 's/,$//')
          else
            # push: å·®åˆ†ã‹ã‚‰ç‰¹å®š
            RULES=$(git diff --name-only HEAD~1 HEAD -- '.claude/rules/*.md' | tr '\n' ',' | sed 's/,$//')
            VALIDATORS=$(git diff --name-only HEAD~1 HEAD -- 'scripts/validators/*.py' | tr '\n' ',' | sed 's/,$//')
          fi

          echo "rules=${RULES}" >> $GITHUB_OUTPUT
          echo "validators=${VALIDATORS}" >> $GITHUB_OUTPUT

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -z "${RULES}" ] && [ -z "${VALIDATORS}" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«/ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«: ${RULES}"
            echo "å¤‰æ›´ã•ã‚ŒãŸãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼: ${VALIDATORS}"
          fi

      - name: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€è¦§ã‚’å–å¾—
        id: plugins
        run: |
          # plugins/é…ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§
          if [ -d plugins ]; then
            PLUGINS=$(find plugins -maxdepth 1 -mindepth 1 -type d | tr '\n' ',' | sed 's/,$//')
            COUNT=$(echo "$PLUGINS" | tr ',' '\n' | grep -c . || echo "0")
          else
            PLUGINS=""
            COUNT=0
          fi

          echo "list=${PLUGINS}" >> $GITHUB_OUTPUT
          echo "count=${COUNT}" >> $GITHUB_OUTPUT
          echo "ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ•°: ${COUNT}"

      - name: plugin-updateãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
        if: steps.changed-files.outputs.has_changes == 'true' && steps.plugins.outputs.count != '0'
        run: |
          if ! gh label list --json name -q '.[].name' | grep -q '^plugin-update$'; then
            gh label create plugin-update \
              --description "ãƒ«ãƒ¼ãƒ«/ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ã«ä¼´ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„ææ¡ˆ" \
              --color "1d76db"
            echo "ãƒ©ãƒ™ãƒ« plugin-update ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "ãƒ©ãƒ™ãƒ« plugin-update ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Codeã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„ã‚’åˆ†æ
        if: steps.changed-files.outputs.has_changes == 'true' && steps.plugins.outputs.count != '0'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          max_turns: 30
          # yamllint disable-line rule:line-length
          claude_args: '--allowedTools "Read,Grep,Glob,Bash(gh issue create:*),Bash(gh issue list:*)"'
          prompt: |
            ã‚ãªãŸã¯Claude Codeãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼ã§ã™ã€‚

            ## ã‚¿ã‚¹ã‚¯
            ãƒ«ãƒ¼ãƒ«/ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°ã«åŸºã¥ãã€å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ”¹å–„ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

            ## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            - ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.changed-files.outputs.rules }}
            - ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼: ${{ steps.changed-files.outputs.validators }}

            ## å¯¾è±¡ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
            ${{ steps.plugins.outputs.list }}

            ## dry_runãƒ¢ãƒ¼ãƒ‰
            ${{ inputs.dry_run || 'false' }}

            ## å®Ÿè¡Œæ‰‹é †

            1. å¤‰æ›´ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€ï¼ˆ.claude/rules/*.mdï¼‰
            2. å¤‰æ›´ã•ã‚ŒãŸãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’èª­ã‚€ï¼ˆscripts/validators/*.pyï¼‰
            3. å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¤ã„ã¦ä»¥ä¸‹ã‚’åˆ†æ:
               a. plugin.jsonï¼ˆ.claude-plugin/plugin.jsonï¼‰ã‚’ç¢ºèª
               b. å„ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
               c. ä»¥ä¸‹ã®è¦³ç‚¹ã§æ”¹å–„ç‚¹ã‚’ç‰¹å®š:
                  - æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ´»ç”¨å¯èƒ½æ€§
                  - æ—¢å­˜å®Ÿè£…ã®æ”¹å–„ç‚¹
                  - éæ¨å¥¨ã«ãªã£ãŸè¨˜æ³•ãŒãªã„ã‹
                  - æ›´æ–°ã•ã‚ŒãŸãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æ²¿ã£ã¦ã„ã‚‹ã‹

            4. æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆ:
               - dry_runãŒtrueã®å ´åˆ: åˆ†æçµæœã®ã¿å‡ºåŠ›ï¼ˆIssueã¯ä½œæˆã—ãªã„ï¼‰
               - dry_runãŒfalseã®å ´åˆ: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«1ã¤ã®Issueã‚’ä½œæˆ
                 - ãƒ©ãƒ™ãƒ«: plugin-update
                 - ã‚¿ã‚¤ãƒˆãƒ«: ã€Œ[ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„] <plugin-name>: <æ¦‚è¦>ã€

            5. æ”¹å–„ææ¡ˆãŒãªã„å ´åˆ:
               ã€Œãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„ææ¡ˆãªã—ã€ã¨å ±å‘Šã—ã¦çµ‚äº†

            ## Issueæœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

            ```markdown
            ## æ¦‚è¦
            [å¤‰æ›´ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãæ”¹å–„ææ¡ˆã®æ¦‚è¦]

            ## å¯¾è±¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            - [ ] `<path/to/file>`

            ## æ”¹å–„å†…å®¹

            ### 1. [æ”¹å–„é …ç›®å]
            **ç¾çŠ¶:**
            [ç¾åœ¨ã®å®Ÿè£…ã®èª¬æ˜]

            **ææ¡ˆ:**
            [æ”¹å–„å¾Œã®å®Ÿè£…ä¾‹]

            **ç†ç”±:** [å‚ç…§: .claude/rules/<rule>.md]

            ## å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            - `.claude/rules/<rule>.md`

            ---
            ğŸ¤– ã“ã®Issueã¯ãƒ«ãƒ¼ãƒ«æ›´æ–°ã«åŸºã¥ã„ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
            ```

            ## é‡è¦
            - PRã¯ä½œæˆã—ãªã„ï¼ˆIssueã®ã¿ï¼‰
            - ãƒ©ãƒ™ãƒ« plugin-update ã¯å¿…ãšä»˜ä¸
            - æ”¹å–„ææ¡ˆãŒãªã„å ´åˆã¯Issueã‚’ä½œæˆã—ãªã„
            - æ—¢å­˜ã®Issueã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã€gh issue listã§ç¢ºèªã—ã¦ã‹ã‚‰ä½œæˆ

      - name: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆ
        if: steps.plugins.outputs.count == '0'
        run: |
          echo "plugins/é…ä¸‹ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"

      - name: å¤‰æ›´ãŒãªã„å ´åˆ
        if: steps.changed-files.outputs.has_changes == 'false'
        run: |
          echo "ãƒ«ãƒ¼ãƒ«/ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã«å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
