name: Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œ

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  auto-implement:
    # claude-code-updateã¾ãŸã¯plugin-updateãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸissueã«åå¿œ
    if: github.event.label.name == 'claude-code-update' || github.event.label.name == 'plugin-update'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: pre-commitã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          pip install pre-commit
          pre-commit install

      - name: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼
        run: |
          if [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "::error::CLAUDE_CODE_OAUTH_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ“ å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"

      - name: ãƒ©ãƒ™ãƒ«ã«åŸºã¥ãè¨­å®šã‚’æ±ºå®š
        id: config
        run: |
          LABEL="${{ github.event.label.name }}"

          if [ "$LABEL" = "claude-code-update" ]; then
            echo "branch_prefix=auto/claude-code-update" >> $GITHUB_OUTPUT
            echo "pr_label=documentation" >> $GITHUB_OUTPUT
            echo "target_type=docs" >> $GITHUB_OUTPUT
          elif [ "$LABEL" = "plugin-update" ]; then
            echo "branch_prefix=auto/plugin-update" >> $GITHUB_OUTPUT
            echo "pr_label=plugin" >> $GITHUB_OUTPUT
            echo "target_type=plugin" >> $GITHUB_OUTPUT
          fi

          echo "ãƒ©ãƒ™ãƒ«: $LABEL"

      - name: ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        id: branch
        run: |
          BRANCH_NAME="${{ steps.config.outputs.branch_prefix }}-issue-${{ github.event.issue.number }}"
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
          if git rev-parse --verify "${BRANCH_NAME}" >/dev/null 2>&1; then
            echo "æ—¢å­˜ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã—ã¾ã™: ${BRANCH_NAME}"
            git branch -D "${BRANCH_NAME}" || true
          fi

          git checkout -b "${BRANCH_NAME}"
          echo "ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¾ã—ãŸ: ${BRANCH_NAME}"

      - name: Issueã®å†…å®¹ã‚’å–å¾—
        id: issue
        run: |
          # Issueæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          gh issue view ${{ github.event.issue.number }} --json title,body --jq '.body' > issue-body.md
          gh issue view ${{ github.event.issue.number }} --json title --jq '.title' > issue-title.txt
          # ã‚¿ã‚¤ãƒˆãƒ«ã‚’outputã«ã‚‚ä¿å­˜ï¼ˆå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
          echo "title=$(cat issue-title.txt | tr -d '\n')" >> $GITHUB_OUTPUT
          echo "å–å¾—å®Œäº†: Issue #${{ github.event.issue.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claudeã§å®Ÿè£…ã‚’å®Ÿè¡Œï¼ˆclaude-code-updateï¼‰
        if: github.event.label.name == 'claude-code-update'
        id: claude-implement-docs
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: 'claude'
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ã‚ãªãŸã¯Claude Codeãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚

            ## ã‚¿ã‚¹ã‚¯
            Issue #${{ github.event.issue.number }} ã®å†…å®¹ã«åŸºã¥ã„ã¦ã€å¿…è¦ãªå®Ÿè£…ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

            ## Issueæƒ…å ±
            - ã‚¿ã‚¤ãƒˆãƒ«: (issue-title.txtã‚’å‚ç…§)
            - æœ¬æ–‡: (issue-body.mdã‚’å‚ç…§)

            ## å®Ÿè¡Œæ‰‹é †

            1. issue-title.txtã¨issue-body.mdã‚’èª­ã‚“ã§ã€Issueã®å†…å®¹ã‚’æŠŠæ¡
            2. CLAUDE.mdã‚’èª­ã‚“ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æŠŠæ¡
            3. .claude/rules/README.md ã‚’èª­ã‚“ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã®å…¨ä½“åƒã‚’æŠŠæ¡
            4. å¿…è¦ã«å¿œã˜ã¦ .claude/rules/ é…ä¸‹ã®é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€
            5. scripts/validators/ é…ä¸‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèªï¼ˆ__init__.py ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸€è¦§ã‚’ç¢ºèªï¼‰
            6. å¿…è¦ãªå¤‰æ›´ã‚’ç‰¹å®šã—ã€ä»¥ä¸‹ã‚’å®Ÿè£…:
               a. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆ.claude/rules/*.mdï¼‰
               b. ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ï¼ˆscripts/validators/*.pyï¼‰
               c. ãƒ†ã‚¹ãƒˆæ›´æ–°ï¼ˆscripts/tests/*.pyï¼‰
            7. å®Ÿè£…å®Œäº†å¾Œã€pre-commitã‚’å®Ÿè¡Œã—ã¦lint/formatã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
               - `pre-commit run --all-files` ã‚’å®Ÿè¡Œ
               - ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°å†…å®¹ã‚’ç¢ºèªã—ã€è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
               - å†åº¦pre-commitã‚’å®Ÿè¡Œã—ã€ã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
            8. ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’ /tmp/change-summary.txt ã«æ›¸ãå‡ºã™
               - å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ¦‚è¦ã‚’ç®‡æ¡æ›¸ãã§è¨˜è¼‰
               - ä¾‹: "- .claude/rules/README.md: ç”¨èªé›†ã«PRFAQã€DDDã‚’è¿½åŠ "

            ## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
            - CLAUDE.md: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆå¿…èª­ï¼‰
            - .claude/rules/: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä»•æ§˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆREADME.mdã«ç´¢å¼•ã‚ã‚Šï¼‰
            - scripts/validators/: ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼å®Ÿè£…
            - scripts/tests/: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

            ## é‡è¦
            - CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã†
            - æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒ
            - æ–°æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚‚è¿½åŠ 
            - ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯æ˜ç¢ºã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã™
            - ä¸æ˜ç¢ºãªéƒ¨åˆ†ã¯ã€ŒTODO: è¦ç¢ºèªã€ã¨ã—ã¦ãƒãƒ¼ã‚¯
            - ãƒªãƒã‚¸ãƒˆãƒªã«æ°¸ç¶šçš„ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä½œæˆãƒ»å¤‰æ›´ã™ã‚‹ã“ã¨
            - issue-body.md, issue-title.txt ãªã©ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‚ç…§ã®ã¿ã§ã€å¤‰æ›´ã‚„ã‚³ãƒŸãƒƒãƒˆã«å«ã‚ãªã„ã“ã¨

          # ãƒ©ãƒ™ãƒ«ã¯æ‰‹å‹•ä»˜ä¸ã®ãŸã‚ã€Edit/Writeã®ãƒ‘ã‚¹åˆ¶é™ã¯ä¸è¦
          # Bashã¯å…¨ã‚³ãƒãƒ³ãƒ‰è¨±å¯ï¼ˆãƒ©ãƒ™ãƒ«ã¯æ‰‹å‹•ä»˜ä¸ãªã®ã§ä¿¡é ¼ã§ãã‚‹ï¼‰
          claude_args: '--max-turns 50 --allowed-tools "Read,Grep,Glob,Edit,Write,Bash(*)"'

      - name: Claudeã§å®Ÿè£…ã‚’å®Ÿè¡Œï¼ˆplugin-updateï¼‰
        if: github.event.label.name == 'plugin-update'
        id: claude-implement-plugin
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: 'claude'
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ã‚ãªãŸã¯Claude Codeãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚

            ## ã‚¿ã‚¹ã‚¯
            Issue #${{ github.event.issue.number }} ã®æ”¹å–„ææ¡ˆã«åŸºã¥ã„ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

            ## Issueæƒ…å ±
            - ã‚¿ã‚¤ãƒˆãƒ«: (issue-title.txtã‚’å‚ç…§)
            - æœ¬æ–‡: (issue-body.mdã‚’å‚ç…§)

            ## å®Ÿè¡Œæ‰‹é †

            1. issue-title.txtã¨issue-body.mdã‚’èª­ã‚“ã§ã€æ”¹å–„ææ¡ˆã®å†…å®¹ã‚’æŠŠæ¡
            2. CLAUDE.mdã‚’èª­ã‚“ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æŠŠæ¡
            3. .claude/rules/ é…ä¸‹ã®é–¢é€£ãƒ«ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            4. å¯¾è±¡ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª:
               - plugin.jsonï¼ˆ.claude-plugin/plugin.jsonï¼‰
               - å„ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
            5. Issueã«è¨˜è¼‰ã•ã‚ŒãŸæ”¹å–„å†…å®¹ã‚’å®Ÿè£…
            6. å®Ÿè£…å®Œäº†å¾Œã€pre-commitã‚’å®Ÿè¡Œã—ã¦lint/formatã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
               - `pre-commit run --all-files` ã‚’å®Ÿè¡Œ
               - ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°å†…å®¹ã‚’ç¢ºèªã—ã€è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
               - å†åº¦pre-commitã‚’å®Ÿè¡Œã—ã€ã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
            7. ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’ /tmp/change-summary.txt ã«æ›¸ãå‡ºã™
               - å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ¦‚è¦ã‚’ç®‡æ¡æ›¸ãã§è¨˜è¼‰
               - ä¾‹: "- plugins/my-plugin/commands/review.md: ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã‚’è¿½åŠ "

            ## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
            - CLAUDE.md: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆå¿…èª­ï¼‰
            - .claude/rules/: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä»•æ§˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆREADME.mdã«ç´¢å¼•ã‚ã‚Šï¼‰
            - plugins/: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

            ## é‡è¦
            - CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã†
            - Issueã®æ”¹å–„ææ¡ˆã«å¿ å®Ÿã«å®Ÿè£…ã™ã‚‹
            - æ—¢å­˜ã®å‹•ä½œã‚’å£Šã•ãªã„ã‚ˆã†æ³¨æ„
            - ãƒªãƒã‚¸ãƒˆãƒªã«æ°¸ç¶šçš„ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä½œæˆãƒ»å¤‰æ›´ã™ã‚‹ã“ã¨
            - issue-body.md, issue-title.txt ãªã©ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‚ç…§ã®ã¿ã§ã€å¤‰æ›´ã‚„ã‚³ãƒŸãƒƒãƒˆã«å«ã‚ãªã„ã“ã¨

          # yamllint disable-line rule:line-length
          claude_args: '--max-turns 50 --allowed-tools "Read,Grep,Glob,Edit,Write,Bash(uvx *),Bash(python3 scripts/*),Bash(npx *),Bash(pre-commit run*)"'

      - name: å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ãªã—"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã‚ã‚Š"
            git diff --stat
          fi

      - name: pre-commitã§æœ€çµ‚æ¤œè¨¼
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "=== æœ€çµ‚æ¤œè¨¼: pre-commitå®Ÿè¡Œ ==="
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          rm -f issue-body.md issue-title.txt
          git add -A

          # pre-commitå®Ÿè¡Œï¼ˆè‡ªå‹•ä¿®æ­£ãŒã‚ã‚Œã°é©ç”¨ï¼‰
          if ! pre-commit run --all-files; then
            echo "è‡ªå‹•ä¿®æ­£ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸã€‚å†åº¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¦æ¤œè¨¼ã—ã¾ã™ã€‚"
            git add -A
            # 2å›ç›®ã®å®Ÿè¡Œ
            if ! pre-commit run --all-files; then
              echo "::error::pre-commitãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ãŒä¸å®Œå…¨ã§ã™ã€‚"
              git status
              git diff
              exit 1
            fi
          fi
          echo "âœ“ ã™ã¹ã¦ã®pre-commitãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹ã—ã¾ã—ãŸ"

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          set -e
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆã‚³ãƒŸãƒƒãƒˆã«å«ã‚ãªã„ãŸã‚ï¼‰
          rm -f issue-body.md issue-title.txt
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A

          # ãƒ©ãƒ™ãƒ«ã«å¿œã˜ã¦ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
          if [ "${{ github.event.label.name }}" = "claude-code-update" ]; then
            COMMIT_DESC="Claude Codeã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ä¼´ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ›´æ–°"
          else
            COMMIT_DESC="ãƒ«ãƒ¼ãƒ«æ›´æ–°ã«ä¼´ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„"
          fi

          git commit -m "feat: Issue #${{ github.event.issue.number }} ã®è‡ªå‹•å®Ÿè£…

          ${COMMIT_DESC}

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
          echo "=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ==="
          echo "ãƒ–ãƒ©ãƒ³ãƒå: ${{ steps.branch.outputs.name }}"
          git remote -v
          echo "==================="

          # æ˜ç¤ºçš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆURLã‚’è¨­å®š
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # å‰å›ã®å®Ÿè¡Œã§ãƒ–ãƒ©ãƒ³ãƒãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚force push
          if ! git push -u --force origin ${{ steps.branch.outputs.name }}; then
            echo "::error::git push ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # PRã«ä»˜ä¸ã™ã‚‹ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ä½œæˆ
          for LABEL in "${{ github.event.label.name }}" "${{ steps.config.outputs.pr_label }}"; do
            if ! gh label list --json name --jq '.[].name' | grep -q "^${LABEL}$"; then
              echo "ãƒ©ãƒ™ãƒ« '${LABEL}' ãŒå­˜åœ¨ã—ãªã„ãŸã‚ä½œæˆã—ã¾ã™"
              gh label create "${LABEL}" --description "è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ©ãƒ™ãƒ«" || true
            else
              echo "ãƒ©ãƒ™ãƒ« '${LABEL}' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: PRã‚’ä½œæˆ
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          ISSUE_TITLE="${{ steps.issue.outputs.title }}"

          # Issueã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ -z "$ISSUE_TITLE" ]; then
            PR_TITLE="feat: Issue #${{ github.event.issue.number }} ã®è‡ªå‹•å®Ÿè£…"
          # [CHANGELOG vX.X.X] å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
          elif [[ "$ISSUE_TITLE" =~ ^\[CHANGELOG\ v[0-9]+\.[0-9]+\.[0-9]+\] ]]; then
            PR_TITLE="$ISSUE_TITLE"
          # [ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„] å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
          elif [[ "$ISSUE_TITLE" =~ ^\[ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„\] ]]; then
            PR_TITLE="$ISSUE_TITLE"
          else
            PR_TITLE="feat: $ISSUE_TITLE"
          fi

          # Claude CodeãŒå‡ºåŠ›ã—ãŸå¤‰æ›´ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
          if [ -f "/tmp/change-summary.txt" ]; then
            CHANGE_SUMMARY=$(cat /tmp/change-summary.txt)
          else
            CHANGE_SUMMARY=""
          fi

          # å¤‰æ›´ã‚µãƒãƒªãƒ¼ãŒç©ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ -z "$CHANGE_SUMMARY" ]; then
            CHANGE_SUMMARY="Claude Actionã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå¤‰æ›´ã§ã™ã€‚è©³ç´°ã¯ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚"
          fi

          # PRæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ï¼ˆã‚·ã‚§ãƒ«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã®å•é¡Œã‚’å›é¿ï¼‰
          ISSUE_NUM="${{ github.event.issue.number }}"

          if [ "${{ github.event.label.name }}" = "claude-code-update" ]; then
            {
              echo "## æ¦‚è¦"
              echo "Issue #${ISSUE_NUM}: ${ISSUE_TITLE}"
              echo ""
              echo "Claude Codeã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«å¯¾å¿œã—ã¾ã™ã€‚"
              echo ""
              echo "## é–¢é€£Issue"
              echo "Closes #${ISSUE_NUM}"
              echo ""
              echo "## å¤‰æ›´å†…å®¹"
              echo "$CHANGE_SUMMARY"
              echo ""
              echo "## ç¢ºèªäº‹é …"
              echo "- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´ãŒé©åˆ‡ã‹"
              echo "- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹"
              echo "- [ ] ãƒ†ã‚¹ãƒˆãŒé€šéã™ã‚‹ã‹"
              echo ""
              echo "---"
              echo "ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
            } > /tmp/pr-body.md
          else
            {
              echo "## æ¦‚è¦"
              echo "Issue #${ISSUE_NUM}: ${ISSUE_TITLE}"
              echo ""
              echo "ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ”¹å–„ææ¡ˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚"
              echo ""
              echo "## é–¢é€£Issue"
              echo "Closes #${ISSUE_NUM}"
              echo ""
              echo "## å¤‰æ›´å†…å®¹"
              echo "$CHANGE_SUMMARY"
              echo ""
              echo "## ç¢ºèªäº‹é …"
              echo "- [ ] ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å¤‰æ›´ãŒé©åˆ‡ã‹"
              echo "- [ ] æ—¢å­˜ã®å‹•ä½œã«å½±éŸ¿ãŒãªã„ã‹"
              echo ""
              echo "---"
              echo "ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
            } > /tmp/pr-body.md
          fi

          gh pr create \
            --title "$PR_TITLE" \
            --body-file /tmp/pr-body.md \
            --label "${{ github.event.label.name }}" \
            --label "${{ steps.config.outputs.pr_label }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆå¤‰æ›´ã‚ã‚Šï¼‰
        if: steps.check-changes.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ğŸ¤– **è‡ªå‹•å®Ÿè£…å®Œäº†**

          PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆå¤‰æ›´ãªã—ï¼‰
        if: steps.check-changes.outputs.has_changes == 'false'
        continue-on-error: true
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ğŸ¤– **è‡ªå‹•å®Ÿè£…çµæœ**

          Issueã®å†…å®¹ã‚’åˆ†æã—ã¾ã—ãŸãŒã€è‡ªå‹•ã§å®Ÿè£…å¯èƒ½ãªå¤‰æ›´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
          æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
