name: Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œ

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  auto-implement:
    # claude-code-updateãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸissueã«ã®ã¿åå¿œ
    if: github.event.label.name == 'claude-code-update'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: pre-commitã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          pip install pre-commit
          pre-commit install

      - name: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼
        run: |
          if [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "::error::CLAUDE_CODE_OAUTH_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ“ å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"

      - name: ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        id: branch
        run: |
          BRANCH_NAME="auto/claude-code-update-issue-${{ github.event.issue.number }}"
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
          if git rev-parse --verify "${BRANCH_NAME}" >/dev/null 2>&1; then
            echo "æ—¢å­˜ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã—ã¾ã™: ${BRANCH_NAME}"
            git branch -D "${BRANCH_NAME}" || true
          fi

          git checkout -b "${BRANCH_NAME}"
          echo "ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¾ã—ãŸ: ${BRANCH_NAME}"

      - name: Issueã®å†…å®¹ã‚’å–å¾—
        id: issue
        run: |
          # Issueæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          gh issue view ${{ github.event.issue.number }} --json title,body --jq '.body' > issue-body.md
          gh issue view ${{ github.event.issue.number }} --json title --jq '.title' > issue-title.txt
          echo "å–å¾—å®Œäº†: Issue #${{ github.event.issue.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claudeã§å®Ÿè£…ã‚’å®Ÿè¡Œ
        id: claude-implement
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ã‚ãªãŸã¯Claude Codeãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚

            ## ã‚¿ã‚¹ã‚¯
            Issue #${{ github.event.issue.number }} ã®å†…å®¹ã«åŸºã¥ã„ã¦ã€å¿…è¦ãªå®Ÿè£…ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

            ## Issueæƒ…å ±
            - ã‚¿ã‚¤ãƒˆãƒ«: (issue-title.txtã‚’å‚ç…§)
            - æœ¬æ–‡: (issue-body.mdã‚’å‚ç…§)

            ## å®Ÿè¡Œæ‰‹é †

            1. issue-title.txtã¨issue-body.mdã‚’èª­ã‚“ã§ã€Issueã®å†…å®¹ã‚’æŠŠæ¡
            2. CLAUDE.mdã‚’èª­ã‚“ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æŠŠæ¡
            3. .claude/rules/README.md ã‚’èª­ã‚“ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã®å…¨ä½“åƒã‚’æŠŠæ¡
            4. å¿…è¦ã«å¿œã˜ã¦ .claude/rules/ é…ä¸‹ã®é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€
            5. scripts/validators/ é…ä¸‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèªï¼ˆ__init__.py ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸€è¦§ã‚’ç¢ºèªï¼‰
            6. å¿…è¦ãªå¤‰æ›´ã‚’ç‰¹å®šã—ã€ä»¥ä¸‹ã‚’å®Ÿè£…:
               a. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆ.claude/rules/*.mdï¼‰
               b. ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ï¼ˆscripts/validators/*.pyï¼‰
               c. ãƒ†ã‚¹ãƒˆæ›´æ–°ï¼ˆscripts/tests/*.pyï¼‰
            7. å®Ÿè£…å®Œäº†å¾Œã€å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’å‡ºåŠ›
               ï¼ˆlint/formatã¯CIå´ã§pre-commitãŒè‡ªå‹•å®Ÿè¡Œã™ã‚‹ãŸã‚ä¸è¦ï¼‰

            ## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
            - CLAUDE.md: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆå¿…èª­ï¼‰
            - .claude/rules/: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä»•æ§˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆREADME.mdã«ç´¢å¼•ã‚ã‚Šï¼‰
            - scripts/validators/: ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼å®Ÿè£…
            - scripts/tests/: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

            ## é‡è¦
            - CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã†
            - æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒ
            - æ–°æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚‚è¿½åŠ 
            - ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯æ˜ç¢ºã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã™
            - ä¸æ˜ç¢ºãªéƒ¨åˆ†ã¯ã€ŒTODO: è¦ç¢ºèªã€ã¨ã—ã¦ãƒãƒ¼ã‚¯
            - ãƒªãƒã‚¸ãƒˆãƒªã«æ°¸ç¶šçš„ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä½œæˆãƒ»å¤‰æ›´ã™ã‚‹ã“ã¨
            - issue-body.md, issue-title.txt ãªã©ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‚ç…§ã®ã¿ã§ã€å¤‰æ›´ã‚„ã‚³ãƒŸãƒƒãƒˆã«å«ã‚ãªã„ã“ã¨

          # ãƒ©ãƒ™ãƒ«ã¯æ‰‹å‹•ä»˜ä¸ã®ãŸã‚ã€Edit/Writeã®ãƒ‘ã‚¹åˆ¶é™ã¯ä¸è¦
          # Bashã¯ç‰¹å®šã‚³ãƒãƒ³ãƒ‰ã®ã¿è¨±å¯ï¼ˆlint/formatã¯git commitæ™‚ã«pre-commitãŒè‡ªå‹•å®Ÿè¡Œï¼‰
          claude_args: '--allowed-tools "Read,Grep,Glob,Edit,Write,Bash(uvx pytest*)"'

      - name: å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ãªã—"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã‚ã‚Š"
            git diff --stat
          fi

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          set -e
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "feat: Issue #${{ github.event.issue.number }} ã®è‡ªå‹•å®Ÿè£…

          Claude Codeã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ä¼´ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ›´æ–°

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
          echo "=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ==="
          echo "ãƒ–ãƒ©ãƒ³ãƒå: ${{ steps.branch.outputs.name }}"
          git remote -v
          echo "==================="

          # æ˜ç¤ºçš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆURLã‚’è¨­å®š
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # å‰å›ã®å®Ÿè¡Œã§ãƒ–ãƒ©ãƒ³ãƒãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚force push
          if ! git push -u --force origin ${{ steps.branch.outputs.name }}; then
            echo "::error::git push ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: PRã‚’ä½œæˆ
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          ISSUE_TITLE=$(cat issue-title.txt | tr -d '\n' | xargs)

          # Issueã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ -z "$ISSUE_TITLE" ]; then
            PR_TITLE="feat: Issue #${{ github.event.issue.number }} ã®è‡ªå‹•å®Ÿè£…"
          # [CHANGELOG vX.X.X] å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
          elif [[ "$ISSUE_TITLE" =~ ^\[CHANGELOG\ v[0-9]+\.[0-9]+\.[0-9]+\] ]]; then
            PR_TITLE="$ISSUE_TITLE"
          else
            PR_TITLE="feat: $ISSUE_TITLE"
          fi

          gh pr create \
            --title "$PR_TITLE" \
            --body "$(cat <<'EOF'
          ## æ¦‚è¦
          Issue #${{ github.event.issue.number }} ã§å ±å‘Šã•ã‚ŒãŸClaude Codeã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«å¯¾å¿œã—ã¾ã™ã€‚

          ## é–¢é€£Issue
          Closes #${{ github.event.issue.number }}

          ## å¤‰æ›´å†…å®¹
          Claude Actionã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå¤‰æ›´ã§ã™ã€‚è©³ç´°ã¯ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

          ## ç¢ºèªäº‹é …
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´ãŒé©åˆ‡ã‹
          - [ ] ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹
          - [ ] ãƒ†ã‚¹ãƒˆãŒé€šéã™ã‚‹ã‹

          ---
          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          )" \
            --label "claude-code-update" \
            --label "documentation"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆå¤‰æ›´ã‚ã‚Šï¼‰
        if: steps.check-changes.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ğŸ¤– **è‡ªå‹•å®Ÿè£…å®Œäº†**

          PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆå¤‰æ›´ãªã—ï¼‰
        if: steps.check-changes.outputs.has_changes == 'false'
        continue-on-error: true
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ğŸ¤– **è‡ªå‹•å®Ÿè£…çµæœ**

          Issueã®å†…å®¹ã‚’åˆ†æã—ã¾ã—ãŸãŒã€è‡ªå‹•ã§å®Ÿè£…å¯èƒ½ãªå¤‰æ›´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
          æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
