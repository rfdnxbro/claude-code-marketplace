name: Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œ

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  auto-implement:
    # claude-code-updateãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸissueã«ã®ã¿åå¿œ
    if: github.event.label.name == 'claude-code-update'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        id: branch
        run: |
          BRANCH_NAME="auto/claude-code-update-issue-${{ github.event.issue.number }}"
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          git checkout -b "${BRANCH_NAME}"

      - name: Issueã®å†…å®¹ã‚’å–å¾—
        id: issue
        run: |
          # Issueæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          gh issue view ${{ github.event.issue.number }} --json title,body --jq '.body' > issue-body.md
          gh issue view ${{ github.event.issue.number }} --json title --jq '.title' > issue-title.txt
          echo "å–å¾—å®Œäº†: Issue #${{ github.event.issue.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claudeã§å®Ÿè£…ã‚’å®Ÿè¡Œ
        id: claude-implement
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ã‚ãªãŸã¯Claude Codeãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚

            ## ã‚¿ã‚¹ã‚¯
            Issue #${{ github.event.issue.number }} ã®å†…å®¹ã«åŸºã¥ã„ã¦ã€å¿…è¦ãªå®Ÿè£…ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

            ## Issueæƒ…å ±
            - ã‚¿ã‚¤ãƒˆãƒ«: (issue-title.txtã‚’å‚ç…§)
            - æœ¬æ–‡: (issue-body.mdã‚’å‚ç…§)

            ## å®Ÿè¡Œæ‰‹é †

            1. issue-title.txtã¨issue-body.mdã‚’èª­ã‚“ã§ã€Issueã®å†…å®¹ã‚’æŠŠæ¡
            2. .claude/rules/ é…ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ã€ç¾åœ¨ã®ä»•æ§˜ã‚’æŠŠæ¡
            3. scripts/validators/ é…ä¸‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèª
            4. å¿…è¦ãªå¤‰æ›´ã‚’ç‰¹å®šã—ã€ä»¥ä¸‹ã‚’å®Ÿè£…:
               a. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆ.claude/rules/*.mdï¼‰
               b. ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ï¼ˆscripts/validators/*.pyï¼‰
               c. ãƒ†ã‚¹ãƒˆæ›´æ–°ï¼ˆscripts/tests/*.pyï¼‰
            5. å¤‰æ›´ã‚’è¡Œã£ãŸã‚‰ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ç¢ºèª:
               uvx pytest scripts/tests/ -v
            6. å®Ÿè£…å®Œäº†å¾Œã€å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’å‡ºåŠ›

            ## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ 
            - .claude/rules/plugin-manifest.md: plugin.jsonã®ä»•æ§˜
            - .claude/rules/marketplace.md: marketplace.jsonã®ä»•æ§˜
            - .claude/rules/agents.md: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
            - .claude/rules/hooks.md: ãƒ•ãƒƒã‚¯å®šç¾©
            - .claude/rules/mcp-servers.md: MCPã‚µãƒ¼ãƒãƒ¼è¨­å®š
            - .claude/rules/lsp-servers.md: LSPã‚µãƒ¼ãƒãƒ¼è¨­å®š
            - .claude/rules/skill-authoring.md: ã‚¹ã‚­ãƒ«ä½œæˆ
            - .claude/rules/slash-commands.md: ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰
            - .claude/rules/output-styles.md: å‡ºåŠ›ã‚¹ã‚¿ã‚¤ãƒ«

            ## é‡è¦
            - CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã†
            - æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒ
            - æ–°æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚‚è¿½åŠ 
            - ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯æ˜ç¢ºã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã™
            - ä¸æ˜ç¢ºãªéƒ¨åˆ†ã¯ã€ŒTODO: è¦ç¢ºèªã€ã¨ã—ã¦ãƒãƒ¼ã‚¯

          # yamllint disable-line rule:line-length
          claude_args: '--allowed-tools "Bash(uvx pytest:*),Bash(uvx ruff:*),Read,Grep,Glob,Edit,Write"'

      - name: å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ãªã—"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã‚ã‚Š"
            git diff --stat
          fi

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "feat: Issue #${{ github.event.issue.number }} ã®è‡ªå‹•å®Ÿè£…

          Claude Codeã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ä¼´ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æ›´æ–°

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push -u origin ${{ steps.branch.outputs.name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: PRã‚’ä½œæˆ
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          gh pr create \
            --title "feat: Claude Codeæ›´æ–°å¯¾å¿œ (Issue #${{ github.event.issue.number }})" \
            --body "$(cat <<'EOF'
          ## æ¦‚è¦
          Issue #${{ github.event.issue.number }} ã§å ±å‘Šã•ã‚ŒãŸClaude Codeã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«å¯¾å¿œã—ã¾ã™ã€‚

          ## é–¢é€£Issue
          Closes #${{ github.event.issue.number }}

          ## å¤‰æ›´å†…å®¹
          Claude Actionã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå¤‰æ›´ã§ã™ã€‚è©³ç´°ã¯ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

          ## ç¢ºèªäº‹é …
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´ãŒé©åˆ‡ã‹
          - [ ] ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹
          - [ ] ãƒ†ã‚¹ãƒˆãŒé€šéã™ã‚‹ã‹

          ---
          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          )" \
            --label "claude-code-update" \
            --label "documentation"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆå¤‰æ›´ã‚ã‚Šï¼‰
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ğŸ¤– **è‡ªå‹•å®Ÿè£…å®Œäº†**

          PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆå¤‰æ›´ãªã—ï¼‰
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ğŸ¤– **è‡ªå‹•å®Ÿè£…çµæœ**

          Issueã®å†…å®¹ã‚’åˆ†æã—ã¾ã—ãŸãŒã€è‡ªå‹•ã§å®Ÿè£…å¯èƒ½ãªå¤‰æ›´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
          æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯Claude Codeè‡ªå‹•æ›´æ–°å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
