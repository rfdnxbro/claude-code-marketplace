name: Claude Code CHANGELOG監視

on:
  schedule:
    # 毎日日本時間9:00（UTC 0:00）に実行
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: '前回チェックを無視して強制実行'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

concurrency:
  group: changelog-monitor
  cancel-in-progress: false

jobs:
  monitor-changelog:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v6

      - name: 最新のCHANGELOGを取得
        id: fetch
        run: |
          if curl --retry 3 --retry-delay 5 -fsSL https://raw.githubusercontent.com/anthropics/claude-code/main/CHANGELOG.md -o current-changelog.md; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "取得完了: $(wc -l < current-changelog.md) 行"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "::error::CHANGELOGの取得に失敗しました"
            exit 1
          fi

      - name: 前回のCHANGELOGと比較
        id: check-diff
        run: |
          if [ -f .changelog-snapshot.md ]; then
            if diff -q .changelog-snapshot.md current-changelog.md > /dev/null 2>&1; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "is_first_run=false" >> $GITHUB_OUTPUT
              echo "CHANGELOGに変更はありません"
              # force_check用に空のdiffファイルを作成
              echo "変更なし" > changelog-diff.txt
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "is_first_run=false" >> $GITHUB_OUTPUT
              echo "CHANGELOGに変更を検出しました"
              diff .changelog-snapshot.md current-changelog.md > changelog-diff.txt || true
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "is_first_run=true" >> $GITHUB_OUTPUT
            echo "初回実行: スナップショットを作成します"
            echo "初回実行のため差分なし" > changelog-diff.txt
          fi

      - name: 初回実行時はスナップショット作成のみ
        if: steps.check-diff.outputs.is_first_run == 'true'
        run: |
          set -e
          cp current-changelog.md .changelog-snapshot.md
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .changelog-snapshot.md
          git commit -m "chore: CHANGELOGスナップショットを初期化"
          git push
          echo "初回実行完了。次回以降の実行で変更を検出します。"

      - name: claude-code-updateラベルを作成（存在しない場合）
        if: (steps.check-diff.outputs.changed == 'true' && steps.check-diff.outputs.is_first_run == 'false') || inputs.force_check
        run: |
          # ラベルが存在しない場合のみ作成
          if ! gh label list --json name -q '.[].name' | grep -q '^claude-code-update$'; then
            gh label create claude-code-update \
              --description "Claude Codeのアップデートによる新機能・変更への対応" \
              --color "6f42c1"
            echo "ラベル claude-code-update を作成しました"
          else
            echo "ラベル claude-code-update は既に存在します"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claudeで変更を解析しIssueを作成
        id: claude-analysis
        if: (steps.check-diff.outputs.changed == 'true' && steps.check-diff.outputs.is_first_run == 'false') || inputs.force_check
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # yamllint disable-line rule:line-length
          claude_args: '--max-turns 20 --allowedTools "Bash(gh issue create:*),Bash(gh issue list:*),Read,Grep,Glob"'
          prompt: |
            あなたはClaude Codeマーケットプレイスのメンテナーです。

            ## タスク
            Claude Code公式リポジトリのCHANGELOGを解析し、プラグイン関連の変更があれば対応してください。

            ## ファイル
            - current-changelog.md: 最新のCHANGELOG
            - .changelog-snapshot.md: 前回チェック時点のCHANGELOG
            - changelog-diff.txt: 差分情報

            ## 検出すべきプラグイン関連の変更
            - プラグイン定義ファイル（plugin.json, marketplace.json等）のフィールド追加・変更・削除
            - プラグインコンポーネント（スラッシュコマンド、エージェント、スキル、フック等）の仕様変更
            - 新しいコンポーネントタイプの追加
            - 既存仕様の非推奨化（deprecated）や削除
            - プラグインコマンド（/plugin install等）の変更

            ## 実行手順

            1. changelog-diff.txtを読んで、差分の概要を把握
            2. current-changelog.mdを読んで、プラグイン関連の変更を特定
            3. .claude/rules/README.md を読んで、現在のドキュメント構造を把握
            4. 必要に応じて .claude/rules/ 配下の関連ドキュメントを確認
            5. プラグイン関連の変更がある場合:
               a. gh issue create で変更内容をまとめたIssueを作成（ラベル: claude-code-update）
               b. 【重要】PRは作成しないでください。Issueのみ作成し、実装は別のCIに任せます
            6. プラグイン関連の変更がない場合:
               a. 「プラグイン関連の変更なし」と報告して終了

            ## 重要
            - 変更があった場合のみIssueを作成（PRは作成しない）
            - Issueにはどのバージョンでどのような変更があったかを明記
            - Issueタイトルは「[CHANGELOG vX.X.X] 」で始める形式にする
            - 不明確な変更は「要確認」としてマーク
            - ラベル claude-code-update は必ず付与する（これにより自動実装CIがトリガーされる）
            - gh issue create が失敗した場合は、エラーメッセージを確認して対処する

      - name: スナップショットを更新
        if: steps.claude-analysis.outcome == 'success'
        run: |
          set -e
          cp current-changelog.md .changelog-snapshot.md
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .changelog-snapshot.md
          git diff --staged --quiet || git commit -m "chore: CHANGELOGスナップショットを更新"
          git push
